{% extends "base.html" %}

{% block title %}Mein Depot - StockBroker App{% endblock %}

{% block content %}
<style>
    /* ... (CSS Styles bleiben unverändert) ... */
    .depot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
</style>

<div class="content-container">
    <div class="depot-header">
        <h1>
            <span id="total-value" style="color: {% if is_profitable %}#198754{% else %}#dc3545{% endif %};">€{{ "{:,.2f}".format(depot.total_net_worth) }}</span>
            <small style="font-size: 0.6em; color: #6c757d;">Gesamtwert</small>
        </h1>
        <div style="display: flex; align-items: center;">

            <div style="margin-left: 40px;">
                <button id="refresh-button" class="form-button">
                    <span class="button-text">Aktualisieren</span>
                </button>
            </div>
        </div>
    </div>

    {% if graph_html %}
    <div class="data-section">
        <h2>Depot-Verlauf</h2>
        {{ graph_html|safe }}
    </div>
    {% endif %}

    <h3>Ihre Positionen</h3>
    <table class="table table-hover" id="positions-table">
        <thead>
            <tr>
                <th>Ticker</th>
                <th style="text-align: right;">Menge</th>
                <th style="text-align: right;">Avg. Kaufpreis</th>
                <th style="text-align: right;">Akt. Kurs</th>
                <th style="text-align: right;">Akt. Wert</th>
                <th style="text-align: center;">Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for pos in depot.positions %}
            <tr>
                <td><strong>{{ pos.ticker }}</strong></td>
                <td style="text-align: right;">{{ pos.quantity }}</td>
                <td style="text-align: right;">€{{ "{:,.2f}".format(pos.average_purchase_price) }}</td>
                <td style="text-align: right;">
                    {% if pos.current_price %}€{{ "{:,.2f}".format(pos.current_price) }}{% else %}<span class="text-muted">N/A</span>{% endif %}
                </td>
                <td style="text-align: right;">
                    {% if pos.current_value %}€{{ "{:,.2f}".format(pos.current_value) }}{% else %}<span class="text-muted">N/A</span>{% endif %}
                </td>
                <td style="text-align: center;">
                    <a href="{{ url_for('stock_detail_page', ticker_symbol=pos.ticker) }}" class="form-button" style="padding: 5px 10px; font-size: 0.85em; background-color: #6c757d;">Details</a>
                    <a href="{{ url_for('trade_page', ticker_symbol=pos.ticker) }}" class="form-button" style="padding: 5px 10px; font-size: 0.85em;">Handeln</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center;">Sie haben noch keine Positionen in Ihrem Depot.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="depot-summary" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <p>Portfolio-Wert: <strong><span id="portfolio-value">€{{ "{:,.2f}".format(depot.portfolio_value) }}</span></strong></p>
            <p>Cash: <strong><span id="cash-balance">€{{ "{:,.2f}".format(depot.cash_balance) }}</span></strong></p>
        </div>
        <div>
            {% if is_profitable %}
                <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExZnU2b243dm52amhocjFraGd1NXp4ZGNiODlibDhqemZyaTV0dHEwbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/YnkMcHgNIMW4Yfmjxr/giphy.gif" alt="Good Stonks" style="width: 173px; height: auto; border-radius: 8px;">
            {% else %}
                <img src="https://media.tenor.com/kkHx0jceFbQAAAAM/stonkseth-stonks.gif" alt="Bad Stonks" style="width: 173px; height: auto; border-radius: 8px;">
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshButton = document.getElementById('refresh-button');
    const buttonText = refreshButton.querySelector('.button-text');

    refreshButton.addEventListener('click', function() {
        // Button deaktivieren und Lade-Zustand anzeigen
        this.disabled = true;
        buttonText.textContent = 'Lädt...';
        const originalBg = this.style.backgroundColor;

        fetch("{{ url_for('api_refresh_depot') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
        .then(result => {
             // === NEUES FEEDBACK OHNE SEITEN-NEULADUNG ===
             if (result.ok) {
                buttonText.textContent = result.body.message;
                this.style.backgroundColor = '#198754'; // Grün für Erfolg
                // Optional: Seite nach Erfolg neu laden, um Werte zu aktualisieren
                setTimeout(() => window.location.reload(), 1000);
             } else {
                buttonText.textContent = result.body.message || 'Fehler';
                this.style.backgroundColor = '#dc3545'; // Rot für Fehler
             }
        })
        .catch(error => {
            console.error('Fetch-Fehler:', error);
            buttonText.textContent = 'Netzwerkfehler!';
            this.style.backgroundColor = '#dc3545';
        })
        .finally(() => {
            // Button nach 3 Sekunden wieder zurücksetzen
            setTimeout(() => {
                this.disabled = false;
                buttonText.textContent = 'Aktualisieren';
                this.style.backgroundColor = originalBg;
            }, 3000);
        });
    });
});
</script>
{% endblock %}